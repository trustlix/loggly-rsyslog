##
# rsyslog config to send data to Loggly.com service

<% if @monitor_files %>

##
# Config file sources

#Only needs to be loaded once, like most rsyslog modules
$ModLoad imfile

  <% node['loggly']['log_files'].each do |logfile| %>
$InputFileName <%= logfile['filename'] %>
$InputFileTag <%= logfile['tag'] %>:
$InputFileStateFile <%= logfile['statefile'] %>
$InputRunFileMonitor
  <% end %>

  <% node['loggly']['log_dirs'].each do |logdir| %>
    <% Dir.foreach(logdir['directory']) do |filename| %>
      <% if filename =~ /[\w\.-_\d]+\.log$/ %>
$InputFileName <%= "#{logdir['directory']}/#{filename}" %>
$InputFileTag <%= logdir['tag'] %>:
$InputFileStateFile state-<%= filename %>
$InputRunFileMonitor
      <% end %>
    <% end %>
  <% end %>

$InputFilePollInterval <%= node['loggly']['input_file_poll_interval'] %>
<% end %>


##
# Config Templates
$template LogglyCatchallFormat,"<%%pri%>%protocol-version% %timestamp:::date-rfc3339% %HOSTNAME% %app-name% %procid% %msgid% [<%= @token %>@41058 <%= @tags %>] %msg%\n"
<% if @monitor_files %>
  <% node['loggly']['log_files'].each do |logfile| %>
$template Loggly<%= logfile['tag'] %>Format,"<%%pri%>%protocol-version% %timestamp:::date-rfc3339% %HOSTNAME% %app-name% %procid% %msgid% [<%= @token %>@41058 tag=\"<%= logfile['tag'] %>\"] %msg%\n"
  <% end %>
  <% node['loggly']['log_dirs'].each do |logdir| %>
$template Loggly<%= logdir['tag'] %>Format,"<%%pri%>%protocol-version% %timestamp:::date-rfc3339% %HOSTNAME% %app-name% %procid% %msgid% [<%= @token %>@41058 tag=\"<%= logdir['tag'] %>\"] %msg%\n"
  <% end %>
<% else %>


<% if node['loggly']['tls']['enabled'] %>
##
# Config TLS
$DefaultNetstreamDriverCAFile <%= node['loggly']['tls']['cert_path'] %>/loggly_full.crt
$ActionSendStreamDriver gtls
$ActionSendStreamDriverMode 1
$ActionSendStreamDriverAuthMode x509/name
$ActionSendStreamDriverPermittedPeer *.loggly.com
<% end %>

##
# Config Rules
<% if @monitor_files %>
  <% node['loggly']['log_files'].each do |logfile| %>
if $programname == <%= logfile['tag'] %> then @@<%= node['loggly']['host'] %>:<%= node['loggly']['port'] %>;Loggly<%= logfile['tag'] %>Format
& stop

  <% end %>
  <% node['loggly']['log_dirs'].each do |logdir| %>
if $programname == <%= logdir['tag'] %> then @@<%= node['loggly']['host'] %>:<%= node['loggly']['port'] %>;Loggly<%= logdir['tag'] %>Format
& stop

  <% end %>
<% else %>
# catch-all logs and send to loggly
*.* @@<%= node['loggly']['host'] %>:<%= node['loggly']['port'] %>;LogglyCatchallFormat
<% end %>
